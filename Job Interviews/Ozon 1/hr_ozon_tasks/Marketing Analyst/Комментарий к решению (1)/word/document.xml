<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<w:document xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:r="http://schemas.openxmlformats.org/officeDocument/2006/relationships" xmlns:v="urn:schemas-microsoft-com:vml" xmlns:w="http://schemas.openxmlformats.org/wordprocessingml/2006/main" xmlns:w10="urn:schemas-microsoft-com:office:word" xmlns:wp="http://schemas.openxmlformats.org/drawingml/2006/wordprocessingDrawing" xmlns:wps="http://schemas.microsoft.com/office/word/2010/wordprocessingShape" xmlns:wpg="http://schemas.microsoft.com/office/word/2010/wordprocessingGroup" xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" xmlns:wp14="http://schemas.microsoft.com/office/word/2010/wordprocessingDrawing" xmlns:w14="http://schemas.microsoft.com/office/word/2010/wordml" mc:Ignorable="w14 wp14"><w:body><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="center"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/></w:rPr><w:t>Комментари</w:t></w:r><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/></w:rPr><w:t>и</w:t></w:r><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/></w:rPr><w:t xml:space="preserve"> к решению</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="center"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/></w:rPr></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="24"/><w:szCs w:val="24"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="24"/><w:szCs w:val="24"/></w:rPr><w:tab/><w:t>В обоих заданиях пробелы в названиях столбцов были заменены на нижнее подчеркивание, то есть, например, Client id → Client_id и т.д. В Google BiqQuerry возможно использование как стандартного диалекта SQL, так и особо диалекта. В решении был использован стандартный диалект.</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="center"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:bCs/><w:sz w:val="40"/><w:szCs w:val="40"/></w:rPr></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:b/><w:bCs/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:bCs/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:t>Task 1.</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:tab/><w:t xml:space="preserve">Идея решения первого задания — использовать оконную функцию ROW_NUMBER() </w:t></w:r><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:t xml:space="preserve">OVER(PARTITION BY Client_id ORDER BY DateTime) </w:t></w:r><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:t>с последующим отбором только тех строк, для которых эта функция вернула 1 или 5.</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:b/><w:bCs/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b/><w:bCs/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:t>Task 2.</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:tab/><w:t xml:space="preserve">Исходя из определения Сессии, данного в условии задачи, клиенты, которые сделали только один Hit, не учитываются в подсчете общего числа сессий, поэтому в Tab1 оставляем только тех клиентов, у которых количество Hit-ов &gt;= 2. </w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:tab/><w:t>В Tab2 вычиляем разницу в секундах между двумя последовательными Hit-ами с использованием оконной функции LAG(). Также проставляем номера Hit-ов (Hit_num) в каждом окне с помощью ROW_NUMBER(). Идея — нам нужны последовательные номера, которые образуют арифметическую прогрессию с шагом 1. Также для каждой строки проставляем флаг того, что разница в секундах между двумя последовательными хитами &gt;1800 секунд (NewSessionFlag).</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:tab/><w:t>В Tab3 вычисляем кумулятивную сумму (Hit_num_shift) в столбце NewSessionFlag внутри каждого окна с помощью SUM() OVER(…).</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:tab/><w:t>В Tab4 вычисляем сумму столбцов Hit_num и Hit_num_shift (Hit_num_shifted). Идея — для последовательности Hit-ов, разница во времени между которыми не более 1800 секунд, значения Hit_num_shifted будут идти последовательно с шагом 1. Как только прошло более 1800 секунд — на этом моменте шаг станет 2, далее снова 1. Далее из  Hit_num_shifted вычитаем row_num (с помощью оконной функции) (получаем Hit_num_final). Hit-ы, имеющие одинаковый  Hit_num_final относятся к одной сессии.</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:tab/><w:t>Наконец, группируем строки по Client_id и  Hit_num_final, считаем количество строк внутри каждой группы, оставляем только те группы, количество строк в которы &gt;1 (по определению Сессии). Итоговый ответ — количество уникальных Client_id из оставшихся после всех операций строк.</w:t></w:r></w:p><w:p><w:pPr><w:pStyle w:val="Normal"/><w:bidi w:val="0"/><w:jc w:val="start"/><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr></w:pPr><w:r><w:rPr><w:rFonts w:ascii="FreeSans" w:hAnsi="FreeSans"/><w:b w:val="false"/><w:bCs w:val="false"/><w:sz w:val="28"/><w:szCs w:val="28"/></w:rPr><w:t>P.S. Некотрые шаги можно было объединить за счет использования JOIN, но для наглядности я решил сделать всё последовательными действиями.</w:t></w:r></w:p><w:sectPr><w:type w:val="nextPage"/><w:pgSz w:w="11906" w:h="16838"/><w:pgMar w:left="1134" w:right="1134" w:header="0" w:top="1134" w:footer="0" w:bottom="1134" w:gutter="0"/><w:pgNumType w:fmt="decimal"/><w:formProt w:val="false"/><w:textDirection w:val="lrTb"/></w:sectPr></w:body></w:document>